# 1. TCP和UDP
### Multiplexing / demultiplexing
* 多路复用(Multiplexing)
	* 指在一个信道上传输多路信号或数据流的过程或技术。由于multiplexing可以将多个低俗信道整合到一个告诉信道进行传输，从而有效利用了高速信道。  
	Combine multiple signals into one signal over a shared medium. The aim is to share a scarce resource.
* 多路分解(Demultiplexing)
	* Host receives IP datagrams
	* Host uses IP addresses & port numbers to direct segment to appropriate socket
		* 主机利用IP地址和端口号来引导segment到合适的socket

# 2. Networking API

# 3. HTTP

# 4. NAT
##### 先简单介绍一些除了TCP和UDP外其它的端口
### RTP
* Real-time transport protocol
* 用来传输语音和视频的(在某些App中有用到)
* UDP做不了的事情RTP也不能做

#### 与TCP的区别
* No acknowledgements
* 接受者知道何时包会被发送，以及发送了多少  
Receiver knows when packet was sent, and how many were sent.

### DCCP
* Datagram Congestion Control Protocol
* UDP加一些修饰，针对对时间敏感的投递 for time-sensitive delivery

## Multipath TCP 多路TCP (新技术)
* 在一个TCP连接的情况下允许多路  
Allows mutiple paths to be used by one TCP connection.
* 例子: Wifi **and** 4G **simultaneously**

#### 多路TCP不单单是为了性能
* 通过在WiFi和4G上进行多路复用，其中一个的失效只会出现一些包丢失，而连接会迅速重新配置。  
By having a link multiplexed over WiFi and 4G, failure of one path appears as just some packet loss, and the link rapidly reconfigures.

* 还可以有效地使用多个网卡

## Address Translation 地址翻译
* 扩展稀缺的IP号码的机制  
Mechanism to extend scarce IP numbers.

* 提供了一些安全性，但并不是设计目标，需谨慎对待
* 打破了端对端理论"end to end principle"

### 基本概念
* **Outbound NAT**:
	* 从较多的IP地址编码为较少的IP地址(本地网到外网)  
	Connection is modified so that connections from multiple source IP addresses are encoded into port number space of a smaller number of addresses
* **Inbound NAT**:
	* 从较少的IP地址(外网)扩张到较多的IP地址(内网)
		* Connection is modified so that connections to multiple ports on a small number of IP addresses are expanded out to a large number of addresses
	* 用单个IP号就能提供多种服务(并且良好的支持虚拟化)  
	Used to offer multiple services from single IP number (goes well with virtualisation to minimise attack surface)
	

### TCP连接的不同由4个点来区分(identify)
* source IP, source port, destination IP, destination port
* 只要其中一个变了我们就可以说这是一个不同的连接
* source 是可以更改的
![](./img/nat.png)
* 加粗的部分就是port
* 在现实中不需要那么复杂的port numbers

<br/>

## NAT在TCP中的结合(重要)
* **Inbound:** 
	1. NAT设备会观测"SYN"包，并且建立一个内网与外网地址的映射  
NAT device sees “SYN” packet and builds a mapping between inside and outside addresses

	2. 修改TCP包(包括IP header，因为要更改源地址为自己的)，重新计算checksums，最后发送包  
Modifies TCP packet (including IP header, as involves change to source address to be own), recomputes check sums, sends packet

* **Outbound:**
	1. 发出：在接收到数据包后，查看源IP和端口，以及目标端口，执行反向映射，最后发送数据包  
On receipt of packets, looks at source IP and port and destination port, performs reverse mapping and sends packet.
	2. 跟踪TCP状态，当完全完成后删除翻译表中对应的条目  
	Tracks TCP state, and deletes entry from translation table when FINs have all completed
	
### NAT在UDP中的结合
* 没有“状态“; No "state as such.
* 重写发出的UDP，然后接受返回包，直到等到一段时间的间隙(10秒通常)  
Rewrite outgoing UDP and then accept return packets until there is silence for 10s (typically).
* 可以对回复的数量施加限制，例如DNS。  
Can also impose limit on number of replies, as for example DNS.

## NAT的问题
1. 对于用户的身份验证和登陆是件非常麻烦的事情  
Makes it very difficult to authenticate and log users

2. NAT日志是carrier级的，却要要求在远程服务器和NAT上进行日志的时间对齐  
NAT logging is part of "carrier grade NAT", but requires time alignment of log on remote server and at the NAT point.

#### Timing Problems
* 服务器上的时间和NAT转发后的时间会不一致
* NAT log 是不会包含URL的，只有IP号

### Logging Problems
* 大多数web日志不包含源端口  
Most web logging does not record source ports. It can, but usually doesn’t.
* 因此很难从NAT点请求日志，因为将有多个连接到相同的服务，仅通过源端口才能区分  
So very difficult to request logs from NAT point, as there will be multiple connections to the same popular service, distinguished only by source port

## NAT Security 安全性
* NAT在概念上是一个有状态防火墙:每个TCP连接都被跟踪状态，每个UDP“连接”至少被监视数量和持续时间  
NAT is conceptually a stateful firewall: each TCP connection is being tracked for state, each UDP “connection” is being at least monitored for volume and duration

* NAT产品没有经过认证或专门用于安全而设计


# 5. DNS
* 将names映射到IP(v4和v6)，将IP映射到names，还有定位源的方法  
Absolutely fundamental to Internet: maps names to IP numbers (v4 and v6), numbers to names, locates resources

* 非常不安全 实现很复杂

* DNS形成了一个松散耦合的分布式数据库，包含成对的key/value  
The DNS forms a loosely coupled distributed database, containing key/value pairs

### Resource Records (RR sets) 源记录(RR集)
* 将name映射到数据  
Map a name to some data, plus have some book-keeping data in them.

* 简单的例子 A records是IPv4地址，AAAA记录是IPv6地址

#### TLL (Time to Live)
* 通常以秒计时，你可以将RR缓存那么长的时间

## DNS 包含的内容
* **Clients**
	* 向递归服务器询问然后接收回应  
	ask questions to recursive servers and receive answers
	


# 6. Other Applications

# 7. 路由端口 Routing Protocols

# 8. Virtual Firewalling

# 9. NTP

# 	